<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Save the Net ‚Äî Vintage Ops Edition</title>
<style>
  :root{
    --bg:#0b0f12;
    --paper:#cfc7b4;     /* beige */
    --paper2:#bfb8a7;
    --ink:#1b1e22;
    --muted:#3b3f46;
    --accent:#0a7a2a;    /* dark green */
    --danger:#a11e1e;
    --shadow: rgba(0,0,0,0.55);
    --glow: rgba(24,255,122,0.15);

    font-family: "MS Sans Serif","Tahoma","Verdana",system-ui,sans-serif;
    font-size: 12px;
  }

  html,body{
    height:100%;
    margin:0;
    background:
      radial-gradient(800px 400px at 20% 10%, rgba(255,255,255,0.04), transparent 55%),
      radial-gradient(700px 450px at 80% 20%, rgba(24,255,122,0.04), transparent 60%),
      linear-gradient(180deg,#0b0f12 0%, #07090b 100%);
    color:#e9efe6;
    user-select:none;
    overflow:hidden;
  }

  .wrap{
    max-width: 1024px;
    margin: 18px auto;
    padding: 10px;
  }

  /* Window chrome */
  .window{
    border: 2px solid #2a2f36;
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.25));
    box-shadow: 0 20px 45px var(--shadow);
    overflow:hidden;
  }
  .titlebar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 8px 10px;
    background: linear-gradient(180deg, #2f3a45, #202830);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    color:#d7e4d9;
    letter-spacing:0.4px;
  }
  .titlebar .left{
    display:flex; align-items:center; gap:8px;
    font-weight:700;
  }
  .lamp{
    width:10px;height:10px;border-radius:2px;
    background: #1aff7a;
    box-shadow: 0 0 10px var(--glow);
  }
  .controls{
    display:flex; gap:6px;
  }
  .ctrl{
    width: 12px; height: 12px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    border-radius: 2px;
  }

  .content{
    display:grid;
    grid-template-columns: 1fr 340px;
    gap: 10px;
    padding: 10px;
  }

  @media(max-width: 980px){
    body{ overflow:auto; }
    .content{ grid-template-columns: 1fr; }
  }

  /* Game panel looks like old terminal window inside */
  .game{
    background: linear-gradient(180deg, rgba(207,199,180,0.06), rgba(0,0,0,0.25));
    border: 2px solid rgba(207,199,180,0.18);
    border-radius: 8px;
    padding: 10px;
    position:relative;
  }

  .crt{
    background: radial-gradient(1000px 600px at 50% 30%, rgba(24,255,122,0.06), transparent 55%),
                linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.25));
    border: 2px solid rgba(0,0,0,0.35);
    border-radius: 6px;
    height: 520px;
    overflow:auto;
    padding: 10px;
    color: #d7f7df;
    text-shadow: 0 0 8px rgba(24,255,122,0.08);
    font-family: "VT323","Courier New",monospace;
    font-size: 18px;
    line-height: 1.15;
    position:relative;
  }

  /* Scanlines + flicker */
  .crt:before{
    content:"";
    position:absolute; inset:0;
    background-image: linear-gradient(rgba(0,0,0,0.08) 50%, transparent 50%);
    background-size: 100% 4px;
    pointer-events:none;
    mix-blend-mode: multiply;
    opacity:0.35;
  }
  .crt:after{
    content:"";
    position:absolute; inset:-2px;
    border-radius: 6px;
    box-shadow: inset 0 0 55px rgba(0,0,0,0.6);
    pointer-events:none;
  }
  @keyframes flicker{
    0%{ opacity: 0.98; }
    50%{ opacity: 1; }
    100%{ opacity: 0.985; }
  }
  .crt{
    animation: flicker 2.2s infinite;
  }

  .side{
    background: linear-gradient(180deg, rgba(207,199,180,0.07), rgba(0,0,0,0.25));
    border: 2px solid rgba(207,199,180,0.18);
    border-radius: 8px;
    padding: 10px;
  }

  .sectionTitle{
    display:flex;justify-content:space-between;align-items:center;
    color:#f0ecd9;
    font-weight:700;
    margin-bottom: 6px;
    text-transform:uppercase;
    letter-spacing:0.6px;
    font-size: 11px;
    opacity:0.95;
  }

  .pill{
    font-family: "MS Sans Serif","Tahoma",sans-serif;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(207,199,180,0.35);
    background: rgba(0,0,0,0.25);
    color:#f0ecd9;
  }

  .inventory{display:flex;flex-direction:column;gap:8px; margin-bottom: 10px;}
  .item{
    display:flex; gap:8px; align-items:flex-start;
    padding: 8px;
    border-radius: 6px;
    background: rgba(0,0,0,0.22);
    border: 1px dashed rgba(207,199,180,0.25);
    color:#f0ecd9;
  }
  .icon{
    width: 28px; height: 28px;
    border-radius: 4px;
    display:grid; place-items:center;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(207,199,180,0.22);
    font-weight: 800;
  }

  .frag{ color: #1aff7a; font-weight: 700; text-shadow: 0 0 8px rgba(24,255,122,0.14); }
  .muted{ color: rgba(240,236,217,0.75); }

  .terminal{
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.55);
    border: 1px solid rgba(207,199,180,0.25);
    border-radius: 6px;
  }
  input[type=text]{
    width:100%;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid rgba(207,199,180,0.35);
    background: rgba(10,12,14,0.75);
    color: #f7f5e8;
    font-family: "VT323","Courier New",monospace;
    font-size: 18px;
    outline:none;
  }
  .btnRow{ display:flex; gap:8px; margin-top:8px; }
  .btn{
    flex:1;
    padding: 10px;
    border-radius: 6px;
    cursor:pointer;
    border: 1px solid rgba(207,199,180,0.35);
    background: linear-gradient(180deg, rgba(207,199,180,0.25), rgba(0,0,0,0.35));
    color:#f0ecd9;
    font-weight:700;
    letter-spacing:0.3px;
  }
  .btn:active{ transform: translateY(1px); }

  .hint{
    margin-top: 6px;
    font-size: 12px;
    color: rgba(240,236,217,0.75);
    min-height: 16px;
  }

  .footer{
    margin-top: 10px;
    text-align:center;
    color: rgba(240,236,217,0.65);
    font-size: 12px;
  }

  .kbd{
    font-family: "MS Sans Serif","Tahoma",sans-serif;
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 4px;
    border: 1px solid rgba(207,199,180,0.3);
    background: rgba(0,0,0,0.35);
    color: rgba(240,236,217,0.9);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="window">
    <div class="titlebar">
      <div class="left">
        <div class="lamp"></div>
        <div>Save the Net | Vintage Ops Edition</div>
        <div class="pill" id="roomPill">Room: START</div>
      </div>
      <div class="controls">
        <div class="ctrl"></div><div class="ctrl"></div><div class="ctrl"></div>
      </div>
    </div>

    <div class="content">
      <section class="game">
        <div id="log" class="crt" aria-live="polite"></div>
        <div class="footer">Tip: <span class="kbd">help</span>, <span class="kbd">map</span>, <span class="kbd">notes</span>, <span class="kbd">assemble</span></div>
      </section>

      <aside class="side">
        <div class="sectionTitle">
          <div>Inventory</div>
          <div class="pill" id="status">Fragments: 0/5</div>
        </div>
        <div id="inventory" class="inventory">
          <div class="item"><div class="icon">‚Äî</div><div style="flex:1">No tools yet</div></div>
        </div>

        <div class="sectionTitle"><div>Terminal</div><div class="pill">Type <span class="kbd">help</span></div></div>
        <div class="terminal">
          <input id="terminalInput" type="text" placeholder="open email" autocomplete="off" />
          <div class="btnRow">
            <button id="runBtn" class="btn">RUN</button>
            <button id="clearBtn" class="btn">CLEAR</button>
          </div>
          <div id="termMsg" class="hint"></div>
        </div>

        <div class="sectionTitle" style="margin-top:10px"><div>Secret</div><div class="pill">Konami</div></div>
        <div class="muted">‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚Üí unlocks‚Ä¶ something questionable.</div>
      </aside>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Core state
----------------------------*/
const game = {
  room: 'start',
  inventory: [],
  fragments: {},        // fragmentKey -> text
  obtained: {},         // one-time flags
  notes: [],
  knownRooms: new Set(['start']),
  konamiProgress: 0
};

const REQUIRED_FRAGS = ['sudo','save_the','net','pipe','commit']; // 5 pieces now

function normalize(s){ return (s||'').trim().toLowerCase(); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Patch is now a proper little chain */
function assembledPatch(){
  const sudo = game.fragments.sudo || '';
  const save = game.fragments.save_the || '';
  const net  = game.fragments.net || '';
  const pipe = game.fragments.pipe || '';
  const com  = game.fragments.commit || '';
  // fun final form
  return `${sudo}${save}${net}${pipe}${com}`; // results in: sudo_save_the_net|commit();
}
function isComplete(){ return REQUIRED_FRAGS.every(k => (game.fragments[k]||'').length>0); }
function haveCount(){ return REQUIRED_FRAGS.filter(k => (game.fragments[k]||'').length>0).length; }
function missingCount(){ return REQUIRED_FRAGS.filter(k => !(game.fragments[k]||'').length).length; }

const konami = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight'];

/* ---------------------------
   World map (rooms + exits)
----------------------------*/
const world = {
  start: { name:"START", exits:['desk','hallway'], desc:[
    "09:13. Your CRT warms your face like a tiny space heater with opinions.",
    "An email pings: SUBJECT: <span class='frag'>CRITICAL network cascade</span> ‚Äî sender: unknown@neonnet.ai",
    "Try <span class='frag'>open email</span> or <span class='frag'>go desk</span>."
  ]},
  desk: { name:"DESK", exits:['hallway'], desc:[
    "Your desk is a museum exhibit: floppy disks, a rubber duck, and a keyboard with three missing keys.",
    "You see: <span class='frag'>floppy</span>, <span class='frag'>duck</span>, and a coffee mug reading 'SEGFAULT HAPPENS'.",
    "Try <span class='frag'>use floppy</span> or <span class='frag'>talk duck</span>."
  ]},
  hallway: { name:"HALLWAY", exits:['desk','server','lab','breakroom','storage'], desc:[
    "A dim hallway lit by exit signs and the glow of ancient monitors.",
    "Doors: <span class='frag'>server room</span>, <span class='frag'>lab</span>, <span class='frag'>break room</span>, <span class='frag'>storage</span>.",
    "Try <span class='frag'>map</span> or <span class='frag'>go server</span>."
  ]},
  server: { name:"SERVER ROOM", exits:['hallway','security'], desc:[
    "The server room hums. Fans scream quietly into the void. LEDs blink in synchronized anxiety.",
    "A console says: <span class='frag'>assemble</span> then <span class='frag'>run patch</span>.",
    "There‚Äôs also a locked door labeled <span class='frag'>SECURITY</span>."
  ]},
  lab: { name:"LAB", exits:['hallway'], desc:[
    "The lab smells like solder and ambition. A whiteboard reads: 'TODAY: make the impossible compile.'",
    "Characters here: <span class='frag'>Marge</span> (sysadmin), <span class='frag'>Chip</span> (intern).",
    "On the table: a cassette labeled <span class='frag'>LOOP.TAPE</span> and a sticky note with <span class='frag'>hex</span> scribbles."
  ]},
  breakroom: { name:"BREAK ROOM", exits:['hallway'], desc:[
    "A break room with a vending machine from 1992 that only accepts exact existential dread.",
    "A flyer: 'Password hygiene seminar'‚Ä¶ with the password ironically printed in tiny text (but smudged).",
    "There‚Äôs a bulletin board full of <span class='frag'>ROT13</span> nonsense."
  ]},
  storage: { name:"STORAGE", exits:['hallway'], desc:[
    "Storage closet. Boxes. Cables. A spiderweb that looks like a network diagram.",
    "You spot a badge lanyard: <span class='frag'>ACCESS CARD</span> (but it‚Äôs behind a logic puzzle panel)."
  ]},
  security: { name:"SECURITY OFFICE", exits:['server'], locked:true, desc:[
    "Security Office. A beige terminal. A bot charging station labeled <span class='frag'>SENTRY-88</span>.",
    "The terminal prompts: 'ENTER ADMIN VERB + CONFIRMATION'.",
    "This room contains something important."
  ]}
};

/* ---------------------------
   Puzzles & items
----------------------------*/
const items = {
  floppy: { name:"Floppy Patch", id:"tool_floppy", icon:"üíæ", gives:{key:'save_the', text:'save_the_'} },
  binary: { name:"Binary Decoder", id:"tool_binary", icon:"üßÆ", gives:{key:'sudo', text:'sudo_'} },
  ductape: { name:"Duct-Tape Cable", id:"tool_duct", icon:"üß∑" },
  accesscard: { name:"Access Card", id:"tool_card", icon:"ü™™" }
};

/* Notes helper */
function note(line){
  game.notes.push(line);
}

/* ---------------------------
   DOM
----------------------------*/
let logEl, invEl, inputEl, runBtn, clearBtn, termMsg, statusEl, roomPill;

function addLog(html){
  const d = document.createElement('div');
  d.innerHTML = html;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

function setRoom(roomKey){
  game.room = roomKey;
  game.knownRooms.add(roomKey);
  roomPill.textContent = `Room: ${world[roomKey].name}`;
  showRoomDesc();
  updateUI();
}

function showRoomDesc(){
  const room = world[game.room];
  addLog(`<div class="muted">[${room.name}]</div>`);
  room.desc.forEach(line => addLog(line));
}

function addInventory(item){
  if(game.inventory.some(x=>x.id===item.id)) return;
  game.inventory.push(item);
  updateUI();
}

function updateUI(){
  // inventory
  invEl.innerHTML = '';
  if(game.inventory.length===0){
    invEl.innerHTML = `<div class="item"><div class="icon">‚Äî</div><div style="flex:1">No tools yet</div></div>`;
  } else {
    game.inventory.forEach(i=>{
      const fragText = fragmentHintForItem(i);
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="icon">${escapeHtml(i.icon||'‚öô')}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(i.name)}</div>
          <div class="muted" style="margin-top:2px;font-size:11px">${fragText}</div>
        </div>`;
      invEl.appendChild(div);
    });
  }

  // status
  statusEl.textContent = `Fragments: ${haveCount()}/${REQUIRED_FRAGS.length}`;
}

function fragmentHintForItem(item){
  // show fragment owned
  const map = {
    tool_binary:'sudo',
    tool_floppy:'save_the',
    tool_card:'(unlock)',
    tool_duct:'(utility)'
  };
  const k = map[item.id];
  if(!k) return '';
  if(game.fragments[k]) return `Fragment: <span class="frag">${escapeHtml(game.fragments[k])}</span>`;
  return `Hint: ${escapeHtml(k)}`;
}

/* One-time reward helper */
function grantOnce(flag, fn){
  if(game.obtained[flag]) return;
  game.obtained[flag]=true;
  fn();
}

/* ---------------------------
   Commands
----------------------------*/
function parse(raw){
  const txt = normalize(raw);
  if(!txt) return;
  addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);

  // Win by manual paste of exact assembled patch (case-insensitive)
  if(isComplete() && txt === normalize(assembledPatch())){
    victory();
    return;
  }

  // Global
  if(txt === 'help'){
    addLog(`<div class="muted">Commands:</div>
      <div class="muted">
      <span class="kbd">go [room]</span> (desk/hallway/server/lab/breakroom/storage/security)<br/>
      <span class="kbd">look</span>, <span class="kbd">map</span>, <span class="kbd">inventory</span>/<span class="kbd">i</span>, <span class="kbd">notes</span><br/>
      <span class="kbd">open email</span>, <span class="kbd">download attachment</span>, <span class="kbd">reply</span><br/>
      <span class="kbd">use [thing]</span>, <span class="kbd">take [thing]</span>, <span class="kbd">talk [name]</span><br/>
      <span class="kbd">assemble</span>, <span class="kbd">run patch</span>, <span class="kbd">reset</span>
      </div>`);
    return;
  }
  if(txt === 'look' || txt === 'l'){
    showRoomDesc();
    return;
  }
  if(txt === 'inventory' || txt === 'i'){
    if(game.inventory.length===0) addLog("Inventory: (empty). The duck judges you softly.");
    else {
      addLog("Inventory:");
      game.inventory.forEach(i=>addLog(`- ${escapeHtml(i.name)}`));
      addLog(`<div class="muted">Fragments:</div>`);
      REQUIRED_FRAGS.forEach(k=>{
        addLog(`<div class="muted">${k} ‚Üí <span class="frag">${escapeHtml(game.fragments[k]||'(missing)')}</span></div>`);
      });
    }
    return;
  }
  if(txt === 'notes'){
    if(game.notes.length===0){ addLog("Notes: (none yet)."); return; }
    addLog("<div class='muted'>Notes:</div>");
    game.notes.slice(-12).forEach(n => addLog(`‚Ä¢ ${n}`));
    return;
  }
  if(txt === 'map'){
    const rooms = Array.from(game.knownRooms).map(r=>world[r].name).join(", ");
    addLog(`<div class="muted">Known rooms:</div> ${escapeHtml(rooms)}`);
    addLog(`<div class="muted">From here you can go:</div> ${world[game.room].exits.map(x=>`<span class="frag">${escapeHtml(world[x].name.toLowerCase())}</span>`).join(" , ")}`);
    return;
  }
  if(txt === 'assemble'){
    addLog("<div class='muted'>Patch assembly:</div>");
    REQUIRED_FRAGS.forEach(k=>{
      addLog(`<div class="muted">${k} ‚Üí <span class="frag">${escapeHtml(game.fragments[k]||'(missing)')}</span></div>`);
    });
    addLog(`<div style="margin-top:6px">Assembled:</div><div><span class="frag">${escapeHtml(assembledPatch()||'(nothing yet)')}</span></div>`);
    if(!isComplete()) addLog(`<div class="muted">Missing ${missingCount()} fragment(s).</div>`);
    return;
  }
  if(txt === 'run patch' || txt === 'run'){
    if(game.room !== 'server'){
      addLog("No terminal access here. Try <span class='frag'>go server</span>.");
      return;
    }
    if(!isComplete()){
      addLog("Patch incomplete. Try <span class='frag'>assemble</span> and keep hunting.");
      return;
    }
    victory();
    return;
  }
  if(txt === 'reset'){
    reset();
    return;
  }

  // Movement
  if(txt.startsWith('go ')){
    const destRaw = txt.slice(3).trim();
    const dest = resolveRoom(destRaw);
    if(!dest){ addLog("Unknown destination. Try <span class='frag'>map</span>."); return; }
    if(!world[game.room].exits.includes(dest)){
      addLog("You can't get there directly from here.");
      return;
    }
    // security lock
    if(dest === 'security' && world.security.locked){
      addLog("The SECURITY door is locked. It wants an <span class='frag'>access card</span> and a <span class='frag'>password</span>.");
      return;
    }
    setRoom(dest);
    return;
  }

  // Email
  if(txt === 'open email'){
    addLog("The email includes an attachment <span class='frag'>cascade_map.bin</span> and a riddle in binary-ish vibes.");
    addLog("Try <span class='frag'>download attachment</span> or <span class='frag'>reply</span>.");
    return;
  }
  if(txt === 'download attachment' || txt === 'download'){
    grantOnce('got_sudo', ()=>{
      addLog("You open 'cascade_map.bin': <span class='frag'>01010011 01010101 01000100 01001111</span>");
      addLog("ASCII says: <span class='frag'>SUDO</span>. Classic.");
      addInventory(items.binary);
      game.fragments.sudo = "sudo_";
      note("Email attachment decoded to SUDO.");
      updateUI();
    });
    if(game.obtained.got_sudo) addLog("You've already decoded that attachment.");
    return;
  }
  if(txt === 'reply'){
    addLog("Auto-reply: 'Find Marge in the lab. She speaks in beeps.'");
    note("Auto-reply points to Marge (lab).");
    return;
  }

  // Use / Take / Talk routing
  if(txt.startsWith('use ')){
    const thing = txt.slice(4).trim();
    useThing(thing);
    return;
  }
  if(txt.startsWith('take ')){
    const thing = txt.slice(5).trim();
    takeThing(thing);
    return;
  }
  if(txt.startsWith('talk ')){
    const who = txt.slice(5).trim();
    talkTo(who);
    return;
  }

  // Puzzle specific shortcuts
  if(txt === 'javascript' || txt === 'answer javascript'){
    if(game.room !== 'lab'){ addLog("No NeonNet prompt here."); return; }
    neonNetReward();
    return;
  }

  // Default
  addLog("Unrecognized. Type <span class='frag'>help</span>.");
}

/* ---------------------------
   Resolution helpers
----------------------------*/
function resolveRoom(raw){
  const r = normalize(raw);
  const aliases = {
    'start':'start',
    'desk':'desk',
    'hall':'hallway',
    'hallway':'hallway',
    'server':'server',
    'server room':'server',
    'lab':'lab',
    'break':'breakroom',
    'breakroom':'breakroom',
    'break room':'breakroom',
    'storage':'storage',
    'closet':'storage',
    'security':'security',
    'security office':'security'
  };
  return aliases[r] || null;
}

function hasItem(id){ return game.inventory.some(i=>i.id===id); }

/* ---------------------------
   Interactions
----------------------------*/
function useThing(raw){
  const t = normalize(raw);

  // Desk things
  if(game.room==='desk'){
    if(t==='floppy' || t==='disk' || t==='use floppy'){
      grantOnce('got_save', ()=>{
        addLog("You slot 'PATCH.1989'. The drive chatters like a tiny angry printer.");
        addLog("On-screen: fragment <span class='frag'>save_the_</span>.");
        addInventory(items.floppy);
        game.fragments.save_the = "save_the_";
        note("Floppy revealed save_the_.");
        updateUI();
      });
      if(game.obtained.got_save) addLog("The floppy has already given up its secrets.");
      return;
    }
    if(t==='duck' || t==='rubber duck'){
      addLog("The duck stares into your soul and then towards the lab.");
      addLog("It squeaks: 'Ask <span class='frag'>Marge</span>. Bring coffee.'");
      note("Duck suggests Marge (lab) and coffee leverage.");
      return;
    }
  }

  // Lab things
  if(game.room==='lab'){
    if(t==='cassette' || t==='loop.tape' || t==='tape'){
      // Morse puzzle: "... --- ..."
      grantOnce('morse_note', ()=>{
        addLog("You press play. The cassette clicks. Beeps emerge:");
        addLog("<span class='frag'>... --- ...</span> then <span class='frag'>.--. .. .--. .</span>");
        addLog("Morse? That second word decodes to <span class='frag'>PIPE</span>.");
        note("Cassette Morse: ...---... then .--... = PIPE");
      });
      addLog("If you want to claim the fragment, convince Marge with the right decoded word.");
      return;
    }
    if(t==='hex' || t==='sticky' || t==='note'){
      // Hex -> ASCII: 6e 65 74
      grantOnce('hex_note', ()=>{
        addLog("Sticky note reads: <span class='frag'>6e 65 74</span>");
        addLog("Hex to ASCII: 6e= n, 65= e, 74= t ‚Üí <span class='frag'>net</span>.");
        note("Hex note decodes to 'net'.");
      });
      addLog("Try telling Chip what it decodes to.");
      return;
    }
  }

  // Breakroom
  if(game.room==='breakroom'){
    if(t==='bulletin' || t==='board' || t==='rot13'){
      grantOnce('rot13_note', ()=>{
        addLog("The bulletin board has a ROT13 line:");
        addLog("<span class='frag'>pbzzvg</span>");
        addLog("That decodes to <span class='frag'>commit</span>.");
        note("ROT13 pbzzvg -> commit");
      });
      addLog("You‚Äôll need the fragment in code-form. Maybe Security Office has the exact syntax.");
      return;
    }
  }

  // Storage
  if(game.room==='storage'){
    if(t==='panel' || t==='logic' || t==='puzzle'){
      addLog("A logic panel lights up:");
      addLog("<div class='muted'>If (A XOR B) = 1 and A = 1, what is B?</div>");
      addLog("Answer with <span class='frag'>talk sentry-88</span> later, or type <span class='frag'>take access card</span> after solving.");
      note("Logic panel: if A XOR B=1 and A=1, then B=?");
      return;
    }
    if(t==='access card' || t==='card'){
      addLog("Try <span class='frag'>take access card</span> (but only after solving the logic panel).");
      return;
    }
  }

  // Server
  if(game.room==='server'){
    if(t==='terminal'){
      addLog("Terminal ready. Use <span class='frag'>assemble</span> then <span class='frag'>run patch</span>.");
      return;
    }
    if(t==='security door' || t==='door'){
      addLog("Locked. Needs <span class='frag'>access card</span> + <span class='frag'>password</span>.");
      return;
    }
  }

  addLog("Nothing happens.");
}

function takeThing(raw){
  const t = normalize(raw);

  if(game.room==='storage' && (t==='access card' || t==='card')){
    // Require logic solved via answering it
    if(!game.obtained.logic_solved){
      addLog("The card is behind a panel. Solve the logic question first.");
      addLog("Hint: XOR outputs 1 when inputs differ.");
      return;
    }
    grantOnce('got_card', ()=>{
      addLog("You retrieve the <span class='frag'>ACCESS CARD</span>. It‚Äôs warm, like it remembers being useful.");
      addInventory(items.accesscard);
      updateUI();
    });
    if(game.obtained.got_card) addLog("You already took the card.");
    return;
  }

  addLog("You can't take that.");
}

function talkTo(raw){
  const who = normalize(raw);

  // Lab characters
  if(game.room==='lab'){
    if(who==='marge' || who==='sysadmin' || who==='admin'){
      addLog("Marge (sysadmin) squints: 'If you want my help, prove you can decode the tape.'");
      addLog("She asks: 'What word did the beeps spell?'");
      addLog("Answer by typing: <span class='frag'>use word pipe</span>.");
      return;
    }
    if(who==='chip' || who==='intern'){
      addLog("Chip (intern) spins in their chair: 'I only trust hex.'");
      addLog("Chip asks: 'What does <span class='frag'>6e 65 74</span> say?'");
      addLog("Answer by typing: <span class='frag'>use word net</span>.");
      return;
    }
  }

  // Security bot exists only in security room
  if(game.room==='security'){
    if(who==='sentry-88' || who==='sentry' || who==='bot'){
      addLog("SENTRY-88 whirs awake: 'AUTH CHALLENGE: LOGIC PANEL RESULT?'");
      addLog("Answer by typing: <span class='frag'>use word 0</span> or <span class='frag'>use word 1</span>.");
      return;
    }
  }

  addLog("No response.");
}

/* Word submission mechanic for puzzles */
function useWordSubmission(word){
  const w = normalize(word);

  // Marge wants PIPE -> awards pipe fragment "|"
  if(game.room==='lab' && !game.fragments.pipe && (w==='pipe')){
    addLog("Marge nods once. This is her version of applause.");
    addLog("She hands you a punched card that reads: <span class='frag'>|</span> (pipe).");
    game.fragments.pipe = "|";
    note("Marge awarded pipe fragment '|'.");
    updateUI();
    return true;
  }

  // Chip wants NET -> awards 'net'
  if(game.room==='lab' && !game.fragments.net && (w==='net')){
    addLog("Chip gasps: 'Correct! That‚Äôs‚Ä¶ literally net.'");
    addLog("Chip gives you a tiny label maker strip: <span class='frag'>net</span>.");
    game.fragments.net = "net";
    note("Chip awarded 'net'.");
    updateUI();
    return true;
  }

  // Storage logic XOR puzzle
  if(game.room==='storage' && !game.obtained.logic_solved && (w==='0' || w==='1')){
    // Condition: (A XOR B)=1 and A=1 => B must be 0
    if(w==='0'){
      addLog("The panel clicks. A hidden latch unlocks. Correct.");
      game.obtained.logic_solved = true;
      note("Logic panel solved: B=0.");
    } else {
      addLog("The panel buzzes. Incorrect. XOR wants DIFFERENT.");
    }
    return true;
  }

  // Security office password challenge (from breakroom flyer)
  if(game.room==='security' && !game.obtained.security_pass && (w==='commit')){
    addLog("The beige terminal accepts: ADMIN VERB confirmed.");
    addLog("It prints: fragment <span class='frag'>commit();</span>");
    game.fragments.commit = "commit();";
    game.obtained.security_pass = true;
    note("Security terminal awarded commit();");
    updateUI();
    return true;
  }

  return false;
}

/* NeonNet reward gated behind talking to Marge & Chip first (harder) */
function neonNetReward(){
  // Require at least 3 notes as proof-of-work
  if(game.notes.length < 3){
    addLog("NeonNet refuses to appear. The air smells like 'insufficient evidence'.");
    addLog("Hint: gather intel in the lab and break room first.");
    return;
  }
  if(game.fragments.sudo && game.fragments.save_the && game.fragments.net){
    addLog("NeonNet flickers onto the lab monitor: 'You‚Äôre doing actual work. Suspicious.'");
    addLog("It grants you the final piece of the chain: <span class='frag'>save_the_net</span> already implies intent. No extra piece needed.");
    addLog("NeonNet adds: 'Security Office will like the word <span class='frag'>commit</span>.'");
    note("NeonNet hints: Security likes 'commit'.");
  } else {
    addLog("NeonNet appears briefly: 'Get more core fragments first.'");
  }
}

/* Unlock Security Office requires Access Card + password word */
function tryUnlockSecurity(){
  if(!world.security.locked) return true;
  if(!hasItem('tool_card')){
    addLog("Need an <span class='frag'>access card</span>.");
    return false;
  }
  addLog("Door reader flashes. It also wants a password (admin verb).");
  addLog("Hint: check the break room's ROT13 board.");
  return false;
}

/* Victory */
function victory(){
  addLog("<div class='muted'>[PATCH TERMINAL]</div>");
  addLog(`You enter: <span class='frag'>${escapeHtml(assembledPatch())}</span>`);
  addLog("The room pauses. Fans spin down slightly, like the building exhaled.");
  addLog("<span class='frag'>‚úÖ NETWORK STABLE</span> ‚Äî cascade contained. Somewhere, a router stops crying.");
  addLog("Marge texts: 'Nice. Don't touch prod again.'");
}

/* Reset */
function reset(){
  game.room='start';
  game.inventory=[];
  game.fragments={};
  game.obtained={};
  game.notes=[];
  game.knownRooms=new Set(['start']);
  game.konamiProgress=0;
  logEl.innerHTML='';
  setRoom('start');
  addLog("<div class='muted'>(World reset.)</div>");
}

/* ---------------------------
   Special command hook: "use word X"
----------------------------*/
function handleSpecialWordCommand(txt){
  if(!txt.startsWith('use word ')) return false;
  const w = txt.slice('use word '.length).trim();
  const ok = useWordSubmission(w);
  if(!ok) addLog("That word doesn't fit any active puzzle here.");
  return true;
}

/* ---------------------------
   Security navigation override
----------------------------*/
function goSecurityOverride(){
  // Called when player tries to go security from server
  if(game.room !== 'server'){ addLog("You are not at the security door."); return; }
  if(world.security.locked){
    if(!tryUnlockSecurity()) return;
  }
  setRoom('security');
}

/* ---------------------------
   Input runner
----------------------------*/
function runInput(){
  const raw = inputEl.value;
  const txt = normalize(raw);
  if(!txt) return;

  inputEl.value='';
  termMsg.textContent='';

  // Konami progress (keyboard) handled elsewhere

  // Special word command
  if(handleSpecialWordCommand(txt)) return;

  // Security entry attempt shortcut
  if(txt === 'go security' || txt === 'go security office'){
    if(game.room === 'server'){
      // If locked, require card AND then password in-room
      if(world.security.locked){
        if(!hasItem('tool_card')){
          addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);
          addLog("Locked. Need <span class='frag'>access card</span>. Try <span class='frag'>go storage</span>.");
          return;
        }
        // unlock door with card, but keep room "locked" until password used in security terminal
        world.security.locked = false;
        addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);
        addLog("Card accepted. Door unlocks with a tired beep.");
        setRoom('security');
        addLog("SENTRY-88 watches you like a disappointed toaster.");
        addLog("Try <span class='frag'>talk sentry-88</span> or <span class='frag'>use word commit</span> (if you found it).");
        return;
      }
      setRoom('security');
      return;
    }
  }

  // If in security and they supply commit, accept
  if(game.room==='security' && (txt==='commit' || txt==='use commit')){
    addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);
    useWordSubmission('commit');
    return;
  }

  // Shortcut: "go X" resolution for rooms not direct
  if(txt.startsWith('go ')){
    const dest = resolveRoom(txt.slice(3));
    if(dest){
      // enforce adjacency
      addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);
      if(!world[game.room].exits.includes(dest)){
        addLog("No direct path. Try <span class='frag'>go hallway</span> first.");
        return;
      }
      if(dest==='security'){
        // handle lock
        if(world.security.locked){
          addLog("Security is locked. Needs <span class='frag'>access card</span>.");
          return;
        }
      }
      setRoom(dest);
      return;
    }
  }

  // Parse normal
  parse(raw);

  // Contextual hinting
  if(txt==='go breakroom') termMsg.textContent = "Try the ROT13 board.";
  if(txt==='go storage') termMsg.textContent = "There‚Äôs a logic panel here.";
  if(txt==='go lab') termMsg.textContent = "Talk to Marge and Chip.";
  if(txt==='go server') termMsg.textContent = "Assemble and run when ready.";
}

/* ---------------------------
   Konami
----------------------------*/
function handleKonami(e){
  if(e.key === konami[game.konamiProgress]){
    game.konamiProgress++;
    if(game.konamiProgress === konami.length){
      addLog("<div class='muted'>[EASTER EGG]</div> The CRT jitters. A secret sticker appears: <span class='frag'>TURBO</span>.");
      addLog("Effect: the CLEAR button now makes a satisfying 'clack' (imaginary).");
      game.konamiProgress=0;
    }
  } else {
    game.konamiProgress=0;
  }
}

/* ---------------------------
   Boot
----------------------------*/
document.addEventListener('DOMContentLoaded', ()=>{
  logEl = document.getElementById('log');
  invEl = document.getElementById('inventory');
  inputEl = document.getElementById('terminalInput');
  runBtn = document.getElementById('runBtn');
  clearBtn = document.getElementById('clearBtn');
  termMsg = document.getElementById('termMsg');
  statusEl = document.getElementById('status');
  roomPill = document.getElementById('roomPill');

  runBtn.addEventListener('click', runInput);
  clearBtn.addEventListener('click', ()=>{ logEl.innerHTML=''; });

  inputEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') runInput();
    handleKonami(e);
  });

  inputEl.addEventListener('input', ()=>{
    const v = normalize(inputEl.value);
    if(!v){ termMsg.textContent=''; return; }
    if('help'.startsWith(v)) termMsg.textContent="Need commands?";
    else if('map'.startsWith(v)) termMsg.textContent="Get your bearings.";
    else if('notes'.startsWith(v)) termMsg.textContent="Review clues.";
    else if('assemble'.startsWith(v)) termMsg.textContent="Build the patch.";
    else if('run patch'.startsWith(v)) termMsg.textContent="Only in server room.";
    else termMsg.textContent="";
  });

  // Start game
  setRoom('start');
  addLog("<div class='muted'>Tip: try <span class='frag'>go desk</span> or <span class='frag'>open email</span>.</div>");

  // Attach a tiny hidden word command parser:
  const oldParse = parse;
  parse = function(raw){
    const txt = normalize(raw);
    if(txt.startsWith('use word ')){
      addLog(`<div><span class="frag">&gt;</span> ${escapeHtml(raw.trim())}</div>`);
      const w = txt.slice(9).trim();
      const ok = useWordSubmission(w);
      if(!ok) addLog("That word doesn't fit here.");
      return;
    }
    return oldParse(raw);
  };
});
</script>
</body>
</html>
